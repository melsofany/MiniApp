# نظام معالجة البطاقات الشخصية - ID Card Processing System

## نظرة عامة
نظام شامل لمعالجة البطاقات الشخصية المصرية باستخدام الذكاء الاصطناعي (Gemini AI) مع تكامل بوت تليجرام وتطبيق مصغر للتقاط الصور، ولوحة تحكم إدارية متقدمة.

## المميزات الرئيسية

### 1. معالجة البطاقات بالذكاء الاصطناعي
- تصحيح اتجاه البطاقة تلقائياً
- تحسين جودة الصورة
- استخراج الاسم والرقم القومي باستخدام Gemini AI
- كشف البطاقات المكررة تلقائياً

### 2. إدارة المندوبين
- إضافة وحذف مندوبين
- تصنيف المندوبين حسب المراكز الثلاثة: طما، طهطا، جهينة
- تفعيل/تعطيل صلاحيات المندوبين
- التحقق من صلاحيات المندوب قبل السماح باستخدام البوت

### 3. الإحصائيات المتقدمة
- إحصائيات حسب المركز (طما، طهطا، جهينة)
- إحصائيات يومية للبطاقات المدخلة
- رسوم بيانية تفاعلية (Recharts)
- عرض عدد المندوبين النشطين والبطاقات المسجلة

### 4. بوت تليجرام
- تحقق من صلاحية المستخدم تلقائياً
- روابط مباشرة لفتح التطبيق المصغر
- رسائل ترحيبية وإرشادية

### 5. التطبيق المصغر (Mini App)
- التقاط صور البطاقات مباشرة من الكاميرا
- واجهة مستخدم عربية بخط Cairo
- حالات واضحة (معالجة، نجاح، خطأ، مكرر)
- تكامل كامل مع Telegram WebApp API

## البنية التقنية

### Backend
- **Express.js**: خادم API
- **Google Sheets API**: قاعدة بيانات (ورقتان: USERS و NATIONAL_ID_DATA)
- **Gemini AI**: معالجة الصور واستخراج البيانات
- **Telegram Bot API**: التكامل مع تليجرام
- **Session Management**: نظام جلسات آمن
- **Multer**: رفع الملفات
- **Zod**: التحقق من صحة المدخلات

### Frontend
- **React + TypeScript**: الواجهة الأمامية
- **Wouter**: التوجيه (Routing)
- **TanStack Query**: إدارة حالة البيانات
- **Shadcn UI**: مكتبة المكونات
- **Tailwind CSS**: التصميم
- **Recharts**: الرسوم البيانية

### الأمان
- ✅ تشفير كلمة المرور (SHA-256)
- ✅ التحقق من Telegram WebApp initData (HMAC-SHA-256)
- ✅ استخراج معلومات المستخدم من التوقيع المُشفّر
- ✅ جلسات آمنة (httpOnly, sameSite: strict, secure في production)
- ✅ التحقق من نوع الملفات المرفوعة
- ✅ Zod validation للمدخلات الحرجة
- ✅ التحقق من صلاحيات المندوب قبل كل عملية

## المتغيرات البيئية المطلوبة

```env
# كلمة مرور الإدارة (مطلوب)
ADMIN_PASSWORD=Elec@alaa2025

# مفتاح الجلسة (مطلوب)
SESSION_SECRET=your-secret-key-here

# توكن بوت تليجرام (مطلوب)
TELEGRAM_BOT_TOKEN=your-telegram-bot-token

# مفتاح Gemini AI (مطلوب)
GEMINI_API_KEY=your-gemini-api-key
```

## هيكل قاعدة البيانات (Google Sheets)

### ورقة USERS
| USER_ID | USERNAME | CENTER | STATUS | DATE_ADDED |
|---------|----------|--------|--------|------------|
| 123456  | ahmed    | طما    | نشط    | 2024-01-01 |

### ورقة NATIONAL_ID_DATA
| NAME | NATIONAL_ID | INSERTED_BY_USERID | INSERTED_BY_USERNAME | CENTER | INSERTION_DATE |
|------|-------------|-------------------|---------------------|--------|----------------|
| أحمد | 12345678901234 | 123456 | ahmed | طما | 2024-01-01 |

## كيفية الاستخدام

### 1. لوحة التحكم الإدارية
1. انتقل إلى `/`
2. أدخل كلمة المرور: `Elec@alaa2025`
3. الوصول إلى:
   - Dashboard: نظرة عامة وإحصائيات
   - إدارة المندوبين: إضافة/حذف مندوبين
   - الإحصائيات: رسوم بيانية تفصيلية
   - سجل البطاقات: عرض جميع البطاقات المسجلة

### 2. استخدام البوت
1. أرسل `/start` للبوت
2. إذا كنت مندوباً نشطاً، سيظهر زر "فتح التطبيق"
3. اضغط على الزر لفتح التطبيق المصغر

### 3. التقاط البطاقات (Mini App)
1. افتح التطبيق المصغر من البوت
2. اضغط "التقاط صورة البطاقة"
3. صوّر الوجه الأمامي للبطاقة بوضوح
4. انتظر المعالجة التلقائية
5. ستظهر النتيجة (نجاح، خطأ، أو مكرر)

## مسار معالجة البطاقة

```
1. المستخدم يلتقط صورة البطاقة
   ↓
2. التحقق من توقيع Telegram WebApp
   ↓
3. استخراج userId من التوقيع المُشفّر
   ↓
4. التحقق من صلاحيات المندوب
   ↓
5. رفع الصورة إلى الخادم
   ↓
6. Gemini AI: تصحيح الاتجاه + تحسين الجودة
   ↓
7. Gemini AI: استخراج الاسم والرقم القومي
   ↓
8. التحقق من عدم وجود رقم قومي مكرر
   ↓
9. حفظ البيانات في Google Sheets
   ↓
10. إرجاع النتيجة للمستخدم
```

## الأنظمة الخلفية

### 1. Keep-Alive System
- يعمل كل 5 دقائق
- يمنع نوم التطبيق على Render
- endpoint: `/api/health`

### 2. Telegram Bot
- يعمل 24/7
- يتحقق من صلاحيات المستخدمين
- يوفر رابط Mini App

### 3. Google Sheets Integration
- إنشاء الأوراق تلقائياً إذا لم تكن موجودة
- تهيئة الهيكل (Headers) تلقائياً عند البدء

## الإصلاحات الأمنية المطبقة

### المرحلة 1: الأساسيات
- ✅ تشفير كلمة المرور (SHA-256)
- ✅ التحقق من وجود متغيرات البيئة الحرجة
- ✅ تحسين أمان الجلسات

### المرحلة 2: التحقق من المدخلات
- ✅ Zod validation لـ login endpoint
- ✅ Zod validation لـ add representative endpoint
- ✅ fileFilter لـ Multer (فقط الصور)

### المرحلة 3: Telegram WebApp Security
- ✅ التحقق من توقيع initData باستخدام HMAC-SHA-256
- ✅ استخراج userId من initData المُوقّع (منع انتحال الشخصية)
- ✅ رفض الطلبات بدون توقيع صحيح

### المرحلة 4: معالجة الأخطاء
- ✅ Google Sheets: throw errors للكشف الفوري
- ✅ logging محسّن للعمليات الحرجة
- ✅ رسائل خطأ واضحة بالعربية

## التحسينات المستقبلية الموصى بها

### حرجة (Critical)
1. **Background Job Processing**
   - استخدام Bull Queue أو similar
   - معالجة الصور بشكل غير متزامن
   - منع timeout على الطلبات الطويلة

2. **Caching Layer**
   - استخدام Redis أو مكتبة caching
   - تخزين نتائج Google Sheets مؤقتاً
   - تقليل الطلبات على Google Sheets API

3. **Rate Limiting**
   - استخدام express-rate-limit
   - حماية من هجمات DDoS
   - تحديد عدد الطلبات لكل مستخدم/IP

4. **CSRF Protection**
   - استخدام csurf middleware
   - حماية admin endpoints

5. **Production Session Store**
   - استخدام connect-redis أو connect-pg-simple
   - بدلاً من MemoryStore الحالية

### مهمة (Important)
1. **Extend Zod Validation**
   - إضافة validation لجميع endpoints
   - التحقق من params و query strings
   - structured error responses

2. **Retry & Backoff للـ Google Sheets**
   - exponential backoff
   - معالجة أخطاء الشبكة تلقائياً

3. **Structured Logging**
   - استخدام Winston أو Pino
   - logs منظمة بـ JSON format
   - سهولة التتبع والتحليل

### محسّنة (Nice-to-have)
1. **Database Migration**
   - الانتقال من Google Sheets إلى PostgreSQL
   - أداء أفضل، قابلية توسع أكبر

2. **Image Optimization**
   - ضغط الصور قبل الإرسال
   - تقليل استخدام bandwidth

3. **Analytics Dashboard**
   - تتبع استخدام النظام
   - معدلات النجاح/الفشل
   - أوقات الذروة

4. **Webhook Support**
   - إشعارات فورية عند إدخال بطاقات
   - تكامل مع أنظمة أخرى

## الأداء الحالي

### نقاط القوة
- ✅ يعمل بشكل موثوق للاستخدام المتوسط (<50 مستخدم متزامن)
- ✅ استجابة سريعة للواجهة الأمامية
- ✅ معالجة دقيقة للصور بـ Gemini AI

### القيود
- ⚠️ معالجة متزامنة قد تسبب تأخير مع 500+ مستخدم متزامن
- ⚠️ عدم وجود caching قد يزيد الحمل على Google Sheets API
- ⚠️ MemoryStore session قد تفقد البيانات عند إعادة التشغيل

### الهدف المستقبلي
- دعم 500 مستخدم متزامن
- معالجة غير متزامنة كاملة
- caching شامل لتقليل latency

## الصيانة

### مراقبة الأنظمة
```bash
# التحقق من حالة جميع الأنظمة
curl https://your-app.replit.app/api/health

# عرض السجلات
tail -f logs/application.log
```

### إعادة التشغيل
```bash
# إعادة تشغيل التطبيق
npm run dev
```

### النسخ الاحتياطي
- Google Sheets يحفظ البيانات تلقائياً
- يُوصى بعمل نسخة يدوية من Google Sheet بشكل دوري

## استكشاف الأخطاء

### مشكلة: "توقيع تطبيق Telegram غير صالح"
- تأكد من أن TELEGRAM_BOT_TOKEN صحيح
- تأكد من فتح التطبيق من داخل تليجرام

### مشكلة: "غير مصرح لك باستخدام هذا النظام"
- تأكد من إضافة المندوب في لوحة التحكم
- تأكد من أن حالة المندوب "نشط"

### مشكلة: "فشل الاتصال بقاعدة البيانات"
- تأكد من صحة اتصال Google Sheets API
- تحقق من صلاحيات الوصول

## الفريق والدعم

### المطور
- تم التطوير بواسطة Replit Agent
- استخدام أفضل الممارسات الحديثة

### الترخيص
- جميع الحقوق محفوظة

## التاريخ
- **2024**: إطلاق النسخة 1.0
- تنفيذ كامل لجميع المميزات الأساسية
- تطبيق إصلاحات أمنية حرجة
- دعم 3 مراكز (طما، طهطا، جهينة)
